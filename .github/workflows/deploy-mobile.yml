name: Build e Deploy APK â†’ Firebase

on:
  push:
    branches:
      - main
    paths:
      - 'mobile/**'

jobs:
  build-and-deploy:
    name: Build APK e Upload Firebase
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do cÃ³digo
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      # 2. Configurar Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      # 3. Instalar dependÃªncias do mobile
      - name: Instalar dependÃªncias
        run: |
          cd mobile
          npm ci

      # 4. Configurar Java (necessÃ¡rio para Gradle)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 5. Gerar projeto Android com Expo Prebuild
      - name: Expo Prebuild
        run: |
          cd mobile
          npx expo prebuild --platform android --non-interactive

      # 6. Configurar keystore para assinar o APK
      - name: Configurar Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > mobile/android/app/agendai-release.keystore

      # 7. Configurar local.properties do Android SDK
      - name: Configurar Android SDK path
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > mobile/android/local.properties

      # 8. Configurar signing no build.gradle
      - name: Configurar assinatura release
        run: |
          cat >> mobile/android/app/build.gradle << 'EOF'

          // Signing config injetado pelo CI
          android.signingConfigs {
            release {
              storeFile file('agendai-release.keystore')
              storePassword '${{ secrets.KEYSTORE_PASSWORD }}'
              keyAlias 'agendai'
              keyPassword '${{ secrets.KEYSTORE_PASSWORD }}'
            }
          }
          android.buildTypes.release.signingConfig = android.signingConfigs.release
          EOF

      # 9. Build do APK
      - name: Build APK Release
        run: |
          cd mobile/android
          ./gradlew assembleRelease --no-daemon

      # 10. Upload para Firebase App Distribution
      - name: Upload para Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          token: ${{ secrets.FIREBASE_TOKEN }}
          file: mobile/android/app/build/outputs/apk/release/app-release.apk
          releaseNotes: |
            ðŸš€ Nova versÃ£o automÃ¡tica!
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
